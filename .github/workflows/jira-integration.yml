name: Jira Integration

on:
  pull_request:
    types: [opened, closed, reopened]
    branches: [main, develop, master]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  update-jira:
    runs-on: ubuntu-latest
    steps:
      - name: Extract Jira Ticket ID
        id: extract
        run: |
          # Extract branch name from PR
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Branch: $BRANCH_NAME"

          # Extract ticket ID (e.g., KAN-123 from feature/KAN-123-description)
          TICKET_ID=$(echo "$BRANCH_NAME" | grep -oE 'KAN-[0-9]+' | head -1)

          if [ -z "$TICKET_ID" ]; then
            echo "No Jira ticket ID found in branch name"
            echo "ticket_id=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Extracted Ticket ID: $TICKET_ID"
          echo "ticket_id=$TICKET_ID" >> $GITHUB_OUTPUT

      - name: Get Jira Transitions
        if: steps.extract.outputs.ticket_id != ''
        id: transitions
        run: |
          TICKET_ID="${{ steps.extract.outputs.ticket_id }}"

          # Check if JIRA_AUTH is set
          if [ -z "${{ secrets.JIRA_AUTH }}" ]; then
            echo "‚ùå JIRA_AUTH secret is not configured"
            echo "Please add JIRA_AUTH secret to your repository settings"
            exit 1
          fi

          # Get available transitions for the ticket
          RESPONSE=$(curl -s -X GET \
            -H "Authorization: Basic ${{ secrets.JIRA_AUTH }}" \
            -H "Accept: application/json" \
            "https://abdo-said.atlassian.net/rest/api/3/issue/$TICKET_ID/transitions")

          # Check if we got an error response
          if echo "$RESPONSE" | jq -e '.errorMessages' > /dev/null 2>&1; then
            echo "‚ùå Error getting transitions:"
            echo "$RESPONSE" | jq '.errorMessages'
            echo ""
            echo "This usually means:"
            echo "1. The JIRA_AUTH secret is incorrect or malformed"
            echo "2. The ticket doesn't exist"
            echo "3. The API token has expired"
            echo ""
            echo "To fix: Go to https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "Delete and recreate the JIRA_AUTH secret with the correct value"
            exit 1
          fi

          echo "Available transitions:"
          echo "$RESPONSE" | jq '.transitions[] | {id: .id, name: .name}'

          # Store transitions for later use
          echo "transitions=$RESPONSE" >> $GITHUB_OUTPUT

      - name: Update Jira Ticket Status
        if: steps.extract.outputs.ticket_id != ''
        run: |
          TICKET_ID="${{ steps.extract.outputs.ticket_id }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_STATE="${{ github.event.action }}"
          PR_MERGED="${{ github.event.pull_request.merged }}"

          # Determine target status based on PR action
          if [ "$PR_STATE" = "opened" ] || [ "$PR_STATE" = "reopened" ]; then
            TARGET_STATUSES=("IN REVIEW" "In Review" "IN PR" "In PR" "CODE REVIEW" "Code Review" "REVIEW" "Review")
            COMMENT="üîç Pull Request opened for review: $PR_URL"
          elif [ "$PR_STATE" = "closed" ] && [ "$PR_MERGED" = "true" ]; then
            TARGET_STATUSES=("QA READY" "QA" "Ready for QA" "TESTING" "Testing" "DONE" "Done" "RESOLVED" "Resolved")
            COMMENT="‚úÖ Pull Request merged: $PR_URL"
          elif [ "$PR_STATE" = "closed" ] && [ "$PR_MERGED" = "false" ]; then
            TARGET_STATUSES=("TO DO" "To Do" "TODO" "BACKLOG" "Backlog" "OPEN" "Open" "REOPENED" "Reopened" "IN PROGRESS" "In Progress")
            COMMENT="‚ùå Pull Request closed without merging: $PR_URL"
          else
            echo "Unknown PR state: $PR_STATE"
            exit 0
          fi

          # Get transitions JSON
          TRANSITIONS='${{ steps.transitions.outputs.transitions }}'

          # Find matching transition ID
          TRANSITION_ID=""
          for status in "${TARGET_STATUSES[@]}"; do
            ID=$(echo "$TRANSITIONS" | jq -r ".transitions[] | select(.name==\"$status\") | .id")
            if [ ! -z "$ID" ] && [ "$ID" != "null" ]; then
              TRANSITION_ID=$ID
              echo "Found transition: $status (ID: $ID)"
              break
            fi
          done

          # Apply transition if found
          if [ ! -z "$TRANSITION_ID" ]; then
            echo "Transitioning to status ID: $TRANSITION_ID"

            # Update ticket status
            TRANSITION_RESPONSE=$(curl -s -X POST \
              -H "Authorization: Basic ${{ secrets.JIRA_AUTH }}" \
              -H "Content-Type: application/json" \
              "https://abdo-said.atlassian.net/rest/api/3/issue/$TICKET_ID/transitions" \
              -d "{\"transition\": {\"id\": \"$TRANSITION_ID\"}}")

            if [ $? -eq 0 ]; then
              echo "‚úÖ Successfully updated ticket status"
            else
              echo "‚ö†Ô∏è Failed to update ticket status"
              echo "$TRANSITION_RESPONSE"
            fi
          else
            echo "‚ö†Ô∏è No matching transition found for statuses: ${TARGET_STATUSES[*]}"
          fi

          # Add comment to Jira ticket
          COMMENT_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Basic ${{ secrets.JIRA_AUTH }}" \
            -H "Content-Type: application/json" \
            "https://abdo-said.atlassian.net/rest/api/3/issue/$TICKET_ID/comment" \
            -d "{
              \"body\": {
                \"type\": \"doc\",
                \"version\": 1,
                \"content\": [
                  {
                    \"type\": \"paragraph\",
                    \"content\": [
                      {
                        \"type\": \"text\",
                        \"text\": \"$COMMENT\"
                      }
                    ]
                  }
                ]
              }
            }")

          if [ $? -eq 0 ]; then
            echo "‚úÖ Successfully added comment to ticket"
          else
            echo "‚ö†Ô∏è Failed to add comment"
            echo "$COMMENT_RESPONSE"
          fi

      - name: Add PR Comment
        if: steps.extract.outputs.ticket_id != '' && github.event.action == 'opened'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const ticketId = '${{ steps.extract.outputs.ticket_id }}';
            const jiraUrl = `https://abdo-said.atlassian.net/browse/${ticketId}`;

            try {
              // Check if we already commented
              const comments = await github.rest.issues.listComments({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo
              });

              const alreadyCommented = comments.data.some(comment =>
                comment.body.includes(`Jira Ticket: [${ticketId}]`)
              );

              if (!alreadyCommented) {
                const comment = `üîó **Jira Ticket:** [${ticketId}](${jiraUrl})\n\nThis PR is linked to Jira ticket ${ticketId}. Status updates will be synchronized automatically.`;

                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
                console.log('‚úÖ Added comment to PR');
              } else {
                console.log('‚ÑπÔ∏è Comment already exists on PR');
              }
            } catch (error) {
              console.log('‚ö†Ô∏è Could not add PR comment (might need permissions):', error.message);
              console.log('This is not critical - the Jira integration still works');
            }